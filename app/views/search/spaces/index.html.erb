<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCiNNIpP8sLtpWlcwLuv_ZqA1NQnbtm_Dk&libraries=places"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->

<div class="row">
  <div class="col-md-6" style="border:1">
    <div class="block-title">
      <h2><strong><%= t "maps" %></strong></h2>
    </div>
    <div id="map-container">
      <div id="map"></div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="block-title">
      <h2><strong><%= t "find_space" %></strong></h2>
    </div>
    <div class="block-full">
      <div class="widget">
        <%= form_tag search_spaces_path, method: :get, remote: true,
          id: "search-space-form" do %>
          <%= text_field_tag  :search, params[:search],
            placeholder: t("search.place_holder"), class: "controls",
            id: "pac-input" %>
        <% end %>
      </div>
      <div class="row" id="search-space-result">
        <%= render "search_result" %>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $(function(){
    $(window).load(function(){
      var input = document.getElementById('pac-input');
      var searchBox = new google.maps.places.SearchBox(input);
      var markers = [];
      latitude = 0;
      longitude = 0;
      
      searchBox.addListener('places_changed', function() {
        form = $('#search-space-form');
        form.submit();
      });

      handler = Gmaps.build('Google');
      handler.buildMap({
          provider: {
            disableDefaultUI: true
            // pass in other Google Maps API options here
          },
          internal: {
            id: 'map'
          }
        },
        function(){
          <% if @hash.present? %>
            markers = handler.addMarkers(<%=raw @hash.to_json %>);
            handler.bounds.extendWith(markers);
            handler.fitMapToBounds();
          <% else %>
            getUserLocationByService();
          <% end %>
        }
      );

      var serviceUrl = "http://freegeoip.net/json/";
      function getUserLocationByService(){
        $.ajax({
          url: serviceUrl
        }).then(function(data) {
          latitude = data.latitude;
          longitude = data.longitude;
          centre_pos = {"lat": latitude, "lng": longitude}
          handler.map.centerOn(centre_pos);
          handler.getMap().setZoom(16);
        });
      }
    });
  });
</script>
